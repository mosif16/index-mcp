# Codex MCP Integration Notes (Reference Only)

> **Operational reminder:** This document is a reference for what Codex CLI supports. Agents should treat it as read-only guidance and **must not** attempt to edit or generate patches for the upstream Codex source tree based on this summary.

- `mcp_servers` in `config.toml` registers third-party MCP servers; examples include Playwright, Figma, documentation search providers, and other entries from the MCP registry (`docs/config.md:337`).
- Runtime config stores these definitions via `McpServerConfig`, supporting per-server startup/tool timeouts and both `stdio` and `streamable_http` transports with optional bearer tokens (`codex-rs/core/src/config.rs:650`, `codex-rs/core/src/config_types.rs:1`, `codex-rs/core/src/config_types.rs:133`).
- `McpConnectionManager` launches each configured server and exposes their tools to the agent, so any MCP-compliant service becomes callable within Codex sessions (`codex-rs/core/src/mcp_connection_manager.rs:203`).
- Enabling the experimental RMCP client unlocks Streamable HTTP support and authentication options for hosted MCP APIs; manage entries with `codex mcp add/list/get/remove` (`docs/config.md:383`, `codex-rs/cli/src/mcp_cmd.rs:26`).
- Codex itself can run as an MCP server, exposing conversation control, approvals, auth helpers, and live `codex/event` streams via `codex mcp-server` for embedding inside other agent frameworks (`codex-rs/docs/codex_mcp_interface.md:1`, `docs/advanced.md:61`).
- `McpConnectionManager` normalizes tool identifiers as `<server>__<tool>` and hashes names that exceed 64 characters so fully qualified tool names stay OpenAI-compatible (`codex-rs/core/src/mcp_connection_manager.rs:1`).
- STDIO MCP launches inherit a curated environment allowlist (`HOME`, `PATH`, etc.) with optional per-server overrides from the `env` table, keeping secrets explicit while still bootstrapping hosted APIs (`codex-rs/mcp-client/src/mcp_client.rs:413`).
- Codex surfaces MCP tool invocations as structured begin/end events with durations and success flags, enabling downstream logging or UI to reflect tool health (`codex-rs/protocol/src/protocol.rs:816`).
- The `codex mcp` CLI supports `add`, `list`, `get --json`, and `remove` commands so you can manage MCP launchers without editing `config.toml` by hand (`codex-rs/cli/src/mcp_cmd.rs:1`).
- Enable `experimental_use_rmcp_client = true` to switch to the RMCP client and reach Streamable HTTP MCP servers; this is documented alongside sample STDIO/HTTP TOML blocks (`docs/config.md:337`, `docs/config.md:383`).
- The `mcp-types` crate is code-generated from the official MCP schema (`generate_mcp_types.py`) and embeds the current version id `2025-06-18`, guaranteeing trait pairs for every request/notification stay in sync with upstream spec changes (`codex-rs/mcp-types/src/lib.rs:1`).
- Codex’s MCP tool catalog currently exposes two schema-driven entries: `codex`, which accepts prompt/model/profile overrides plus approval/sandbox toggles and optional plan tool flags, and `codex-reply`, which resumes an existing conversation with required `conversation_id` + `prompt` fields (`codex-rs/mcp-server/src/codex_tool_config.rs:1`, `codex-rs/mcp-server/src/codex_tool_config.rs:324`).
- `MessageProcessor` enforces a single `initialize` handshake, captures the client’s user-agent, and maps MCP request ids to Codex conversation ids so follow-up `codex-reply` calls route to the right session (`codex-rs/mcp-server/src/message_processor.rs:33`).
- When enumerating external tools Codex fans out requests concurrently via `JoinSet`, honoring per-server startup/tool timeouts and warning (rather than aborting) when a server misbehaves—so slow or flaky MCP servers don’t block others (`codex-rs/core/src/mcp_connection_manager.rs:339`).
- The RMCP adapter wraps the official SDK, wiring both STDIO child processes and Streamable HTTP transports, logging server stderr for troubleshooting, and sharing the same env allowlist utilities as the legacy client (`codex-rs/rmcp-client/src/rmcp_client.rs:27`).
- RMCP helpers normalize tool responses by replacing missing `content` arrays and provide bidirectional serde conversions between `rmcp` models and Codex’s `mcp-types`, avoiding schema drift (`codex-rs/rmcp-client/src/utils.rs:1`).
- `OutgoingMessageSender` multiplexes MCP responses and server-originated requests, storing one-shot callbacks per `requestId` and automatically attaching `_meta.requestId` when streaming `codex/event` notifications back to the client (`codex-rs/mcp-server/src/outgoing_message.rs:1`).
- MCP server messaging only honours a single `initialize`; subsequent calls return `Already initialized`, while all other methods short-circuit to `Not initialized` until the handshake succeeds—useful to ensure Codex CLI connects cleanly before invoking tools (`codex-rs/mcp-server/src/message_processor.rs:33`).
- MCP tool calls inherit per-server timeouts (`startup_timeout_sec`/`tool_timeout_sec`) and are dispatched concurrently, so large tool catalogs stay responsive and a hung server doesn’t stall the rest (`codex-rs/core/src/mcp_connection_manager.rs:339`).
- Approval prompts enqueued through MCP preserve correlation by reusing the JSON-RPC id for the matching `applyPatchApproval`/`execCommandApproval` request, letting clients resolve the dialog based on prior command context (`codex-rs/mcp-server/src/outgoing_message.rs:59`).
- **Client → Codex requests** (JSON-RPC `method`): `initialize`, `newConversation`, `sendUserMessage`, `sendUserTurn`, `interruptConversation`, `listConversations`, `resumeConversation`, `archiveConversation`, plus tool discovery `tools/list` and tool execution `tools/call` (the latter used by Codex MCP tools like `codex` and `codex-reply`) (`codex-rs/app-server-protocol/src/protocol.rs:55`).
- **Codex → client responses**: `newConversation` returns `{ conversationId, model, reasoningEffort?, rolloutPath }`, while `resumeConversation` can include `initialMessages` to hydrate UI state; both rely on `ConversationId` for follow-up tool calls (`codex-rs/app-server-protocol/src/protocol.rs:236`).
- **Codex → client notifications**: `codex/event` (streamed agent events with `_meta.requestId`), `authStatusChange`, `loginChatGptComplete`, and `sessionConfigured` for TUI state sync (`codex-rs/mcp-server/src/outgoing_message.rs:278`, `codex-rs/app-server-protocol/src/protocol.rs:779`).
- **Codex → client requests** (requires human approval): `applyPatchApproval { conversationId, callId, fileChanges, reason?, grantRoot? }` and `execCommandApproval { conversationId, callId, command, cwd, reason? }`; clients must reply `{ decision: "allow" | "deny" }` (`codex-rs/app-server-protocol/src/protocol.rs:657`).
- `CallToolResult` payloads Codex returns to MCP clients mirror MCP spec: `content` (array of text or rich blocks), optional `structured_content`, and `is_error` flag; Codex normalizes empty `content` arrays before sending (`codex-rs/mcp-server/src/message_processor.rs:431`, `codex-rs/rmcp-client/src/utils.rs:1`).
